{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoRydz Chatbot</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0c0c0c 0%, #0d0d0e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .chat-container {
            max-width: 32rem;
            background: #1a1a1a;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        #chat-messages {
            height: 28rem;
            overflow-y: auto;
            padding: 1.5rem;
            background: #222222;
            scroll-behavior: smooth;
        }
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #333333;
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 3px;
        }
        .message {
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease-out;
        }
        .user-message {
            text-align: right;
        }
        .ai-message .bubble {
            background: #2d2d2d;
            border: 1px solid #444444;
            color: #e5e5e5;
        }
        .user-message .bubble {
            background: #3b82f6;
            color: white;
        }
        .bubble {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            display: inline-block;
            max-width: 80%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        .timestamp {
            font-size: 0.65rem;
            color: #888888;
            margin-top: 0.25rem;
        }
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .quick-reply-btn {
            background: #444444;
            color: #e5e5e5;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .quick-reply-btn:hover {
            background: #555555;
        }
        .typing .bubble {
            background: #2d2d2d;
            color: #888888;
            font-style: italic;
            animation: pulse 1.2s infinite;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="bg-black p-4 flex items-center justify-between border-b border-gray-800">
            <div class="flex items-center space-x-3">
                <img src="{{ MEDIA_URL }}cars/Logo.png" alt="GoRydz" class="w-10 h-auto">
                <h1 class="text-lg font-semibold text-white">GoRydz Chatbot</h1>
            </div>
            <button id="clear-chat" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1 rounded-full text-sm">Clear</button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages">
            <div class="message ai-message">
                <div class="bubble">
                    <span class="text-base">üöó</span> Welcome to GoRydz! Ask about our cars, services, or locations like Colombo!
                </div>
                <div class="timestamp text-left">Just now</div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-black flex items-center space-x-3">
            <input type="text" id="user-input" placeholder="Ask about cars or services..." class="flex-1 p-2 bg-gray-900 text-white border border-gray-700 rounded-full focus:outline-none focus:border-blue-500 text-sm">
            <button class="send-button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm font-medium" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // GoRydz company details
        const companyDetails = {
            whyChoose: "Experience the ultimate car rental service with our commitment to excellence and customer satisfaction. We offer a wide selection of premium vehicles, transparent pricing with no hidden fees, 24/7 customer support, an easy online booking system, flexible rental periods, and fully insured vehicles.",
            contact: "Contact us at +94 77 123 4567, email: info@gorydz.com, address: 123 Main Street, Negombo, Sri Lanka. Operating hours: Monday to Sunday, 8:00 AM to 10:00 PM.",
            services: "From economy cars to luxury vehicles, we have the perfect ride for every occasion. Our services include daily and weekly rentals, airport pickup/drop-off, long-term leasing, corporate fleet solutions, wedding and event cars, and GPS navigation systems."
        };

        // Car details array
        const cars = [
            { brand: "Mitsubishi", model: "Lancer Ex", year: 2008, location: "Kalutara, Colombo", seats: 4, pricePerDay: 4000.00, rating: "4.8 (127 reviews)", description: "Year: 2008, Transmission: Automatic, Fuel Type: Petrol, Engine: 1,500cc, Mileage: 212,000 km, Condition: Used, well-maintained, Body Type: Saloon", availability: "Available" },
            { brand: "BMW", model: "X1", year: 2020, location: "Main Office", seats: 4, pricePerDay: 7000.00, rating: "4.8 (127 reviews)", description: "Condition: Used, Transmission: Automatic, Body Type: SUV / 4x4, Fuel Type: Petrol, Engine Capacity: 1,500 cc, Mileage: 87,000 km", availability: "Available" },
            { brand: "Audi", model: "A3", year: 2015, location: "Main Office", seats: 4, pricePerDay: 5000.00, rating: "4.8 (127 reviews)", description: "Condition: Used, Transmission: Automatic, Body Type: Saloon, Fuel Type: Petrol, Engine Capacity: 1,800 cc, Mileage: 60,000 km", availability: "Available" },
            { brand: "Toyota", model: "Axio Corolla", year: 2024, location: "Main Office", seats: 4, pricePerDay: 5200.00, rating: "4.8 (127 reviews)", description: "Condition: New, Transmission: Automatic, Body Type: Saloon, Fuel Type: Petrol, Engine Capacity: 1,500 cc, Mileage: 102 km", availability: "Available" },
            { brand: "Honda", model: "Vezel Z", year: 2025, location: "Main Office", seats: 4, pricePerDay: 6000.00, rating: "4.8 (127 reviews)", description: "Condition: Used, Transmission: Tiptronic, Body Type: Saloon, Fuel Type: Hybrid, Engine Capacity: 1,500 cc, Mileage: 169 km", availability: "Available" },
            { brand: "Toyota", model: "Vitz", year: 2015, location: "Main Office", seats: 4, pricePerDay: 3000.00, rating: "4.8 (127 reviews)", description: "Condition: Used, Transmission: Automatic, Body Type: Hatchback, Fuel Type: Petrol, Engine Capacity: 1,000 cc, Mileage: 160,000 km", availability: "Available" },
            { brand: "Toyota", model: "Premio", year: 2014, location: "Kalutara, Colombo, Galle", seats: 5, pricePerDay: 4500.00, rating: "4.8 (127 reviews)", description: "Condition: Used, Transmission: Automatic, Body Type: Saloon, Fuel Type: Petrol, Engine Capacity: 1,500 cc, Mileage: 160,000 km", availability: "Available" },
            { brand: "Perodua", model: "Axia", year: 2021, location: "Kalutara, Colombo, Galle", seats: 4, pricePerDay: 2000.00, rating: "Not rated", description: "Condition: Used ‚Äì Good, Transmission: Automatic, Body Type: Hatchback, Fuel Type: Petrol, Engine Capacity: 1,000 cc, Mileage: 12,400 km", availability: "Available" },
            { brand: "Honda", model: "Vezel Hybrid", year: 2023, location: "Kalutara, Negombo, Kandy, Galle", seats: 5, pricePerDay: 6000.00, rating: "Not rated", description: "Condition: New, Transmission: Automatic (Hybrid), Body Type: SUV, Fuel Type: Petrol / Hybrid, Engine Capacity: 1,500 cc, Mileage: 85 km", availability: "Available" },
            { brand: "Mitsubishi", model: "Mirage", year: 2017, location: "Kalutara, Negombo, Kandy, Galle, Colombo", seats: 4, pricePerDay: 2000.00, rating: "Not rated", description: "Condition: Used ‚Äì Excellent, Transmission: Automatic, Body Type: Hatchback, Fuel Type: Petrol, Engine Capacity: 1,200 cc, Mileage: 14,500 km", availability: "Available" }
        ];

        // Conversation context
        let conversationContext = { lastCar: null, lastTopic: null, lastLocation: null };

        // Custom messages for car details
        function getCustomMessage(car, type) {
            const messages = {
                price: [
                    `üí∞ Great choice! The ${car.brand} ${car.model} is priced at LKR ${car.pricePerDay.toLocaleString()} per day. This includes insurance coverage and 24/7 roadside assistance. Weekly discounts available!`,
                    `üè∑Ô∏è The daily rental rate for the ${car.brand} ${car.model} is LKR ${car.pricePerDay.toLocaleString()}. We offer competitive pricing with no hidden fees - what you see is what you pay!`,
                    `üí≥ Our ${car.brand} ${car.model} is available for LKR ${car.pricePerDay.toLocaleString()} per day. This price includes comprehensive insurance and unlimited mileage within city limits.`
                ],
                details: [
                    `üîç Here are the complete specifications for the ${car.brand} ${car.model}: ${car.description}. This vehicle has been thoroughly inspected and serviced for your safety and comfort.`,
                    `üìã Detailed information about the ${car.brand} ${car.model}: ${car.description}. All our vehicles undergo regular maintenance and safety checks before each rental.`,
                    `‚öôÔ∏è Technical details for the ${car.brand} ${car.model}: ${car.description}. This car comes with our standard warranty coverage during your rental period.`
                ],
                year: [
                    `üìÖ The ${car.brand} ${car.model} is a ${car.year} model, ensuring you get ${car.year >= 2020 ? 'modern features and latest technology' : 'reliable performance with proven track record'}. Perfect for your journey!`,
                    `üóìÔ∏è This ${car.brand} ${car.model} is from ${car.year}. ${car.year >= 2022 ? 'It\'s one of our newest additions with cutting-edge features!' : 'A well-maintained classic that offers great value for money.'}`,
                    `üìÜ The model year is ${car.year} for this ${car.brand} ${car.model}. ${car.year >= 2021 ? 'Enjoy the latest automotive technology and safety features!' : 'Experience the reliability and durability this model is known for.'}`
                ],
                location: [
                    `üìç You can pick up the ${car.brand} ${car.model} from: ${car.location}. We also offer convenient delivery service to your preferred location for an additional fee.`,
                    `üó∫Ô∏è The ${car.brand} ${car.model} is available at our ${car.location} ${car.location.includes('Main Office') ? 'location' : 'locations'}. Free pickup and drop-off available within a 5km radius!`,
                    `üìå Available locations for the ${car.brand} ${car.model}: ${car.location}. We can arrange vehicle delivery to airports, hotels, or your doorstep - just let us know your preference!`
                ],
                seats: [
                    `üë• The ${car.brand} ${car.model} comfortably seats ${car.seats} passengers. ${car.seats >= 5 ? 'Perfect for family trips or group outings!' : 'Ideal for couples or small groups who prefer comfort and fuel efficiency.'}`,
                    `ü™ë This ${car.brand} ${car.model} has a seating capacity of ${car.seats} people. All seats feature ${car.year >= 2020 ? 'premium upholstery and ergonomic design' : 'comfortable cushioning'} for long journeys.`,
                    `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Seating capacity: ${car.seats} passengers in the ${car.brand} ${car.model}. ${car.seats === 4 ? 'Spacious interior with ample legroom for all passengers.' : 'Extra room for larger groups or families with luggage.'}`
                ],
                rating: [
                    `‚≠ê Customer rating for the ${car.brand} ${car.model}: ${car.rating}. ${car.rating.includes('4.8') ? 'Our customers love this vehicle for its reliability and comfort!' : car.rating === 'Not rated' ? 'This is a newer addition to our fleet - be among the first to experience it!' : 'Highly rated by our satisfied customers!'}`,
                    `üåü The ${car.brand} ${car.model} has earned ${car.rating}. ${car.rating.includes('reviews') ? 'Join hundreds of satisfied customers who have enjoyed this vehicle!' : 'New to our fleet and ready to impress!'}`,
                    `‚≠ê Rating: ${car.rating} for the ${car.brand} ${car.model}. ${car.rating !== 'Not rated' ? 'This high rating reflects our commitment to quality and customer satisfaction.' : 'Fresh addition to our premium fleet - experience it first!'}`
                ]
            };
            
            const messageArray = messages[type] || [`Information about ${type} for ${car.brand} ${car.model}.`];
            return messageArray[Math.floor(Math.random() * messageArray.length)];
        }

        // Load chat history
        function loadChatHistory() {
            const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
            history.forEach(msg => appendMessage(msg.type, msg.content, msg.timestamp, msg.quickReplies));
            $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
        }

        // Save chat history
        function saveChatHistory() {
            const messages = [];
            $('#chat-messages .message').each(function() {
                const type = $(this).hasClass('user-message') ? 'user' : 'ai';
                const content = $(this).find('.bubble').text();
                const timestamp = $(this).find('.timestamp').text();
                const quickReplies = [];
                $(this).find('.quick-reply-btn').each(function() { quickReplies.push($(this).text()); });
                messages.push({ type, content, timestamp, quickReplies });
            });
            localStorage.setItem('chatHistory', JSON.stringify(messages));
        }

        // Append message
        function appendMessage(type, content, timestamp = new Date().toLocaleTimeString(), quickReplies = []) {
            const messageClass = type === 'user' ? 'user-message' : 'ai-message';
            let html = `
                <div class="message ${messageClass}">
                    <div class="bubble">${type === 'ai' ? '<span class="text-base">üöó</span> ' : ''}${content}</div>
                    <div class="timestamp ${type === 'user' ? 'text-right' : 'text-left'}">${timestamp}</div>
            `;
            if (quickReplies.length > 0) {
                html += '<div class="quick-replies">';
                quickReplies.forEach(reply => {
                    html += `<button class="quick-reply-btn" onclick="handleQuickReply('${reply}')">${reply}</button>`;
                });
                html += '</div>';
            }
            html += '</div>';
            $('#chat-messages').append(html);
            $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
            saveChatHistory();
        }

        // Handle quick reply
        function handleQuickReply(reply) {
            const car = cars.find(c => `${c.brand} ${c.model}`.toLowerCase() === reply.toLowerCase());
            if (car) {
                conversationContext.lastCar = car;
                conversationContext.lastTopic = 'car';
                $('#user-input').val(reply);
                const response = getCustomMessage(car, 'details');
                appendMessage('user', reply);
                const quickReplies = ['Price', 'Details', 'Year', 'Location', 'Seats', 'Rating'];
                setTimeout(() => {
                    $('.typing-message').remove();
                    appendMessage('ai', response, new Date().toLocaleTimeString(), quickReplies);
                }, 1000);
                $('#chat-messages').append(`<div class="message ai-message typing-message"><div class="bubble typing">Thinking...</div></div>`);
            } else {
                $('#user-input').val(reply);
                sendMessage();
            }
        }

        // Identify car or location
        function identifyCarOrLocation(message) {
            message = message.toLowerCase();
            const carPatterns = {
                "mitsubishi lancer": /mitsubishi|lancer/,
                "bmw x1": /bmw|x1/,
                "audi a3": /audi|a3/,
                "toyota axio corolla": /toyota.*(axio|corolla)/,
                "honda vezel z": /honda.*(vezel.*z)/,
                "toyota vitz": /toyota.*vitz/,
                "toyota premio": /toyota.*premio/,
                "perodua axia": /perodua|axia/,
                "honda vezel hybrid": /honda.*(vezel.*hybrid)/,
                "mitsubishi mirage": /mitsubishi.*mirage/
            };
            const locationPatterns = {
                "kalutara": /kalutara/,
                "colombo": /colombo/,
                "galle": /galle/,
                "negombo": /negombo/,
                "kandy": /kandy/,
                "main office": /main office/
            };
            for (const [key, pattern] of Object.entries(carPatterns)) {
                if (pattern.test(message)) {
                    const [brand, model] = key.split(' ');
                    const car = cars.find(car => car.brand.toLowerCase() === brand && car.model.toLowerCase() === model.replace('ex', 'Ex').replace('z', 'Z').replace('hybrid', 'Hybrid'));
                    if (car) return { type: 'car', value: car };
                }
            }
            for (const [location, pattern] of Object.entries(locationPatterns)) {
                if (pattern.test(message)) {
                    const matchedCars = cars.filter(car => car.location.toLowerCase().includes(location));
                    return { type: 'location', value: location, cars: matchedCars };
                }
            }
            return null;
        }

        // Check related query
        function isRelatedQuery(message) {
            const keywords = [
                "mitsubishi", "lancer", "bmw", "x1", "audi", "a3", "toyota", "axio", "corolla", "honda", "vezel",
                "vitz", "premio", "perodua", "axia", "mirage", "car", "price", "details", "seats", "year", "location",
                "rating", "description", "gorydz", "why choose", "contact", "services", "rental", "booking", "support",
                "fleet", "airport", "wedding", "leasing", "gps", "book", "reserve", "availability", "kalutara", "colombo",
                "galle", "negombo", "kandy", "main office"
            ];
            return keywords.some(keyword => message.toLowerCase().includes(keyword));
        }

        // Generate response
        function generateResponse(message) {
            message = message.toLowerCase();
            let quickReplies = [];
            
            if (message.includes("why choose") || message.includes("gorydz")) {
                conversationContext.lastTopic = 'company';
                quickReplies = ['Contact Info', 'Our Services'];
                return `GoRydz offers: ${companyDetails.whyChoose}`;
            } else if (message.includes("contact")) {
                conversationContext.lastTopic = 'company';
                quickReplies = ['Why Choose Us', 'Our Services'];
                return `Contact GoRydz at: ${companyDetails.contact}`;
            } else if (message.includes("services") || message.includes("rental") || message.includes("booking") ||
                       message.includes("fleet") || message.includes("airport") || message.includes("wedding") ||
                       message.includes("leasing") || message.includes("gps")) {
                conversationContext.lastTopic = 'company';
                quickReplies = ['Why Choose Us', 'Contact Info'];
                return `GoRydz provides: ${companyDetails.services}`;
            }

            // Check for specific detail requests with context
            if (conversationContext.lastCar) {
                const car = conversationContext.lastCar;
                if (message.includes("price") || message.includes("cost") || message.includes("rate")) {
                    quickReplies = ['Details', 'Year', 'Location', 'Seats', 'Rating'];
                    return getCustomMessage(car, 'price');
                } else if (message.includes("details") || message.includes("description") || message.includes("specs")) {
                    quickReplies = ['Price', 'Year', 'Location', 'Seats', 'Rating'];
                    return getCustomMessage(car, 'details');
                } else if (message.includes("year") || message.includes("model year")) {
                    quickReplies = ['Price', 'Details', 'Location', 'Seats', 'Rating'];
                    return getCustomMessage(car, 'year');
                } else if (message.includes("location") || message.includes("where")) {
                    quickReplies = ['Price', 'Details', 'Year', 'Seats', 'Rating'];
                    return getCustomMessage(car, 'location');
                } else if (message.includes("seats") || message.includes("capacity")) {
                    quickReplies = ['Price', 'Details', 'Year', 'Location', 'Rating'];
                    return getCustomMessage(car, 'seats');
                } else if (message.includes("rating") || message.includes("reviews")) {
                    quickReplies = ['Price', 'Details', 'Year', 'Location', 'Seats'];
                    return getCustomMessage(car, 'rating');
                } else if (message.includes("book") || message.includes("reserve") || message.includes("availability")) {
                    quickReplies = ['Contact Info', 'Price', 'Details'];
                    return `üéâ Great news! The ${car.brand} ${car.model} is ${car.availability.toLowerCase()} for booking. Contact us now to secure your reservation and enjoy a premium driving experience!`;
                }
            }
            
            let result = identifyCarOrLocation(message);
            if (result) {
                if (result.type === 'car') {
                    const car = result.value;
                    conversationContext.lastCar = car;
                    conversationContext.lastTopic = 'car';
                    quickReplies = ['Price', 'Details', 'Year', 'Location', 'Seats', 'Rating'];
                    
                    if (message.includes("price") || message.includes("cost") || message.includes("rate")) {
                        return getCustomMessage(car, 'price');
                    } else if (message.includes("details") || message.includes("description") || message.includes("specs")) {
                        return getCustomMessage(car, 'details');
                    } else if (message.includes("year") || message.includes("model year")) {
                        return getCustomMessage(car, 'year');
                    } else if (message.includes("location") || message.includes("where")) {
                        return getCustomMessage(car, 'location');
                    } else if (message.includes("seats") || message.includes("capacity")) {
                        return getCustomMessage(car, 'seats');
                    } else if (message.includes("rating") || message.includes("reviews")) {
                        return getCustomMessage(car, 'rating');
                    } else if (message.includes("book") || message.includes("reserve") || message.includes("availability")) {
                        quickReplies.push('Contact Info');
                        return `üéâ The ${car.brand} ${car.model} is ${car.availability.toLowerCase()} for booking. Let's get you on the road - contact us for immediate reservation!`;
                    } else {
                        return `‚ú® You've selected the ${car.brand} ${car.model} - an excellent choice! This ${car.year} model offers great value and performance. What would you like to know about it?`;
                    }
                } else if (result.type === 'location') {
                    const location = result.value.charAt(0).toUpperCase() + result.value.slice(1);
                    const matchedCars = result.cars;
                    conversationContext.lastLocation = location;
                    conversationContext.lastTopic = 'location';
                    quickReplies = matchedCars.map(car => `${car.brand} ${car.model}`);
                    if (matchedCars.length > 0) {
                        return `üèôÔ∏è Available cars in ${location}: ${matchedCars.map(car => `${car.brand} ${car.model}`).join(', ')}. Which vehicle catches your interest?`;
                    } else {
                        return `üìç Unfortunately, no cars are currently available in ${location}. However, we have vehicles in Colombo, Kalutara, and Negombo. We can also arrange delivery to your location!`;
                    }
                }
            }
            
            quickReplies = ['Contact Info', 'Our Services'];
            return "ü§î I'd love to help you find the perfect car! Please specify which vehicle or location you're interested in, and I'll provide detailed information.";
        }

        // Send message
        function sendMessage() {
            var userInput = $('#user-input').val().trim();
            if (userInput === '') return;
            appendMessage('user', userInput);
            $('#user-input').val('');
            $('#chat-messages').append(`<div class="message ai-message typing-message"><div class="bubble typing">Thinking...</div></div>`);
            setTimeout(() => {
                $('.typing-message').remove();
                const response = generateResponse(userInput);
                const quickReplies = conversationContext.lastTopic === 'car' ? ['Price', 'Details', 'Year', 'Location', 'Seats', 'Rating'] :
                                     conversationContext.lastTopic === 'company' ? ['Why Choose Us', 'Contact Info', 'Our Services'] :
                                     conversationContext.lastTopic === 'location' ? cars.filter(car => car.location.toLowerCase().includes(conversationContext.lastLocation.toLowerCase())).map(car => `${car.brand} ${car.model}`) :
                                     ['Contact Info', 'Our Services'];
                appendMessage('ai', response, new Date().toLocaleTimeString(), quickReplies);
            }, 1000);
        }

        // Clear chat
        $('#clear-chat').click(function() {
            $('#chat-messages').empty();
            localStorage.removeItem('chatHistory');
            conversationContext = { lastCar: null, lastTopic: null, lastLocation: null };
            appendMessage('ai', "Chat cleared. Welcome to GoRydz! Ask about our cars, services, or locations like Colombo!");
        });

        // Send on Enter key
        $('#user-input').keypress(function(e) {
            if (e.which == 13) {
                sendMessage();
            }
        });

        // Auto-focus input
        $('#user-input').focus();

        // Load initial history
        $(document).ready(function() {
            loadChatHistory();
            if ($('#chat-messages').children().length === 0) {
                appendMessage('ai', "Welcome to GoRydz! Ask about our cars, services, or locations like Colombo!");
            }
        });
    </script>
</body>
</html>